####################################
# Load Preset Configuration
####################################

import %workspace%/tools/preset.bazelrc

####################################
# Persistent Caches (survive 'bazel clean --expunge')
####################################

# Repository cache - stores downloaded dependencies
# Lives outside the output_base, so it persists across clean operations
# Initialize with: bash tools/setup/init_bazel_env.sh
common --repository_cache=~/.bazel/repo-cache

# Optional: Distribution mirror for offline builds
# Uncomment to enable: bazel build //... --distdir=~/.bazel/distdir
# common --distdir=~/.bazel/distdir

# Persistent build artifact cache (optional, for CI/local development)
# Survives 'bazel clean' but is cleared with 'bazel clean --expunge'
build --disk_cache=~/.bazel/build-cache

####################################
# Bazel 9 Optimizations
####################################

# Enable external include paths feature (Bazel 9 default: -I instead of -isystem)
build --features=external_include_paths

# Auto-cleanup of stale action cache entries
build --experimental_action_cache_gc_max_age=7d

####################################
# Project-Specific Configuration
####################################

common --color=yes
common --curses=yes

# Default build platform for this project (macOS ARM64)
build --platforms=//config/platforms:macos_arm64_platform

# Build metadata
build --workspace_status_command=tools/scripts/workspace_status.sh

####################################
# Debug Build (with ASAN/UBSAN)
####################################

build:debug --compilation_mode=dbg
build:debug --strip=never
build:debug --copt=-O0
build:debug --copt=-g
build:debug --copt=-fno-omit-frame-pointer
build:debug --copt=-fsanitize=address
build:debug --copt=-fsanitize=undefined
build:debug --linkopt=-fsanitize=address
build:debug --linkopt=-fsanitize=undefined
build:debug --define=DEBUG=1
build:debug --features=layering_check
build:debug --sandbox_debug

test:debug --config=debug

####################################
# Release Build (Optimized)
####################################

build:opt --compilation_mode=opt
build:opt --strip=always
build:opt --copt=-O3
build:opt --copt=-march=native
build:opt --define=NDEBUG=1

####################################
# Profile/Report Build
####################################

build:profile --compilation_mode=opt
build:profile --copt=-O2
build:profile --copt=-g
build:profile --copt=-ftime-report
build:profile --profile=profile.gz
build:profile --generate_json_trace_profile

####################################
# Benchmark Build
####################################

build:benchmark --compilation_mode=opt
build:benchmark --strip=always
build:benchmark --define=NDEBUG=1
build:benchmark --copt=-O3
build:benchmark --copt=-march=native

test:benchmark --config=benchmark

####################################
# Code Coverage (LLVM Coverage)
####################################

coverage --combined_report=lcov
coverage --instrumentation_filter="^//app/.*"
coverage --experimental_use_llvm_covmap
coverage --copt=-fprofile-instr-generate
coverage --copt=-fcoverage-mapping
coverage --copt=-ffile-prefix-map=$(PWD)=.
coverage --copt=-fdebug-prefix-map=$(PWD)=.
coverage --linkopt=-fprofile-instr-generate
coverage --linkopt=-fcoverage-mapping
coverage --experimental_generate_llvm_lcov

####################################
# Static Analysis (clang-tidy)
####################################

build:tidy --aspects=@bazel_tools//tools/cpp:cc_code_coverage.aspect
build:tidy --features=layering_check
build:tidy --copt=-fdiagnostics-color=always

####################################
# Cross-Compile: Linux with Homebrew LLVM
####################################

build:linux_llvm --action_env=CC=/opt/homebrew/opt/llvm/bin/clang
build:linux_llvm --action_env=CXX=/opt/homebrew/opt/llvm/bin/clang++
build:linux_llvm --action_env=BAZEL_USE_CPP_ONLY_TOOLCHAIN=1
build:linux_llvm --cxxopt=-stdlib=libc++
build:linux_llvm --linkopt=-fuse-ld=lld
build:linux_llvm --platforms=@platforms//os:linux
build:linux_llvm --cpu=x86_64

test:linux_llvm --config=linux_llvm
